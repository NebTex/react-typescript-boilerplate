image: node:6

cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
  - node_modules/
  untracked: true
stages:
  - build
  - push

production build:
  only:
    - master
  stage: build
  script:
    - apt-get update -y && apt-get install apt-transport-https -y
    - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    - apt-get update -y && apt-get install git yarn -y
    - yarn install
    - yarn global add jest
    - export PATH="./node_modules/.bin:$PATH"
    - yarn build
    - yarn build:landing
  artifacts:
    paths:
    - dist
    - dist_landing

publish_landing:
  only:
    - master
  stage: push
  script:
    - wget -O- -q http://s3tools.org/repo/deb-all/stable/s3tools.key | apt-key add -
    - wget -O/etc/apt/sources.list.d/s3tools.list http://s3tools.org/repo/deb-all/stable/s3tools.list
    - apt-get update -y && apt-get install s3cmd -y
    - s3cmd sync ./dist_landing/  s3://menshend.io/
  artifacts:
    paths:
    - dist_landing

push:
  only:
    - master
  stage: push
  script:
    - mkdir -p $HOME/.ssh
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - git config --global user.name "nebot"
    - git config --global user.email devbot@nebtex.com
    - echo -e "$nebot_key" > $HOME/.ssh/id_rsa
    - echo -e "$nebot_gpg" > $HOME/private.key
    - gpg --import $HOME/private.key
    - chmod 400 $HOME/.ssh/id_rsa
    - git clone git@github.com:nebtex/menshend.git
    - rm -rf  menshend/ui
    - mkdir -p menshend/ui
    - cp ./dist/* menshend/ui/
    - cd menshend 
    - git commit -S -m "update ui to the latest version"
    - git push origin master
  artifacts:
    paths:
    - dist